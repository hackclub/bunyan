<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title></title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Lobster&display=swap');
      h1 {
        font-family: 'Lobster', cursive;
        position: relative;
        font-size: 5em;
      }
      .header-container {
        margin: 0 auto;
      }
      .header {
        margin-bottom: 24px;
        position:relative;
        display: inline-block;
      }
      .header::before {
        content: 'Find out';
        font-size: 36px;
        position: absolute;
        font-weight: lighter;
        transform: rotate(-6deg);
        top: -20px;
        color: red;
      }
      .header::after {
        content: 'on the hack club slack';
        font-family: sans;
        position: absolute;
        font-size: 36px;
        bottom: -20px;
        right: 0;
      }
      body {
        background-image: url('https://cloud-oth8cndgs-hack-club-bot.vercel.app/0grid.svg');
        color: whitesmoke;
        text-align: center;
        align-content: center;
        justify-content: center;
        margin: 0;
        padding: 0;
        background: #2e2e2e;
      }

      pre {
        padding: 1em;
        display: inline-block;
        text-align: left;
        margin: 0 auto !important;
        background: rgba(138, 109, 109, 0.3);
        border-radius: 10px;
      }
    </style>
  </head>
  <body>
    <div class="header-container">
      <h1 class="header">What's poppin'</h1>
    </div>
    <p class="updated"><em>Loading...</em></p>
    <div class="results"></div>
    <p>This was created with <a href="https://streamboot-bot.herokuapp/">Streamboot</a></p>
    <details>
      <summary>See the raw data</a></summary>
      <pre><code class="raw-data">
        Loading...
      </code></pre>
    </details>
  </body>
  <script>
    var data = {
      channels: [],
      updatedAt: null
    }

    function run() {
      let success = false
      fetch('https://streamboot-bot.herokuapp.com/api/convos')
      .then(r => 
        r.json()
      ).then(channels => {
        if (channels) {
          data.updatedAt = Date.now()
          data.channels = channels.filter(c => c.slack_id[0] === 'C').filter(c => c.forecast != 0).sort((a, b) => {
            return b.average - a.average
          })
          success = true
        }
      }).finally(() => {
        // render all the data (success or not)
        const updateEl = document.querySelector('.updated')
        if (data.updatedAt) {
          let date = new Date(data.updatedAt)
          updateEl.innerHTML = `Latest data pulled at <strong>${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}</strong>`
        } else {
          updateEl.innerHTML = `<em>(Failed to load latest data, will retry shortly)</em>`
        }

        const resultEl = document.querySelector('.results')
        const dataEl = document.querySelector('.raw-data')
        if (data.channels) {
          resultEl.innerHTML = `⚠️ something has gone wrong`
          dataEl.innerHTML = "// https://stream-bot.herokuapp.com/api/convos/\n" + JSON.stringify(data.channels, null, 2)
        } else {
          resultEl.innerHTML = `⚠️ something has gone wrong`
          dataEl.innerHTML = `⚠️ something has gone wrong`
        }
      })
    }

    run()

    setInterval(run, 1000 * 15)// ever 15 seconds, update the list
  </script>
</html>